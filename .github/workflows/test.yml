name: ğŸ¤– ClaudeCode è‡ªå‹•ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒŠãƒª

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [main, develop]

jobs:
  code-review:
    runs-on: self-hosted  # ã‚»ãƒ«ãƒ•ãƒ›ã‚¹ãƒˆãƒ©ãƒ³ãƒŠãƒ¼ã‚’ä½¿ç”¨ãƒŠãƒªï¼
    
    steps:
    - name: ğŸ“¥ ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆãƒŠãƒª
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # å…¨å±¥æ­´ã‚’å–å¾—ã—ã¦diffã‚’è¦‹ã‚‹ãƒŠãƒª
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: ğŸ” å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—ãƒŠãƒª
      id: changed-files
      run: |
        # PRã§å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã‚’å–å¾—ãƒŠãƒª
        git diff --name-only origin/${{ github.base_ref }}..HEAD > changed_files.txt
        echo "changed-files=$(cat changed_files.txt | tr '\n' ' ')" >> $GITHUB_OUTPUT
        echo "ğŸ“ å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«:"
        cat changed_files.txt

    - name: ğŸ” Claudeèªè¨¼çŠ¶æ…‹ç¢ºèªãƒŠãƒª
      run: |
        echo "ğŸ” ClaudeMAXãƒ—ãƒ©ãƒ³ã®èªè¨¼çŠ¶æ…‹ã‚’ãƒã‚§ãƒƒã‚¯ãƒŠãƒª..."
        ./check_claude_auth.sh

    - name: ğŸš€ ClaudeCode ã§ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼å®Ÿè¡ŒãƒŠãƒªï¼ˆMAXãƒ—ãƒ©ãƒ³ï¼‰
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        PR_NUMBER: ${{ github.event.number }}
        REPO_OWNER: ${{ github.repository_owner }}
        REPO_NAME: ${{ github.event.repository.name }}
        # ClaudeMAXãƒ—ãƒ©ãƒ³ã¯ãƒ­ãƒ¼ã‚«ãƒ«èªè¨¼ã‚’ä½¿ç”¨ãƒŠãƒª
      run: |
        echo "ğŸ¯ ClaudeMAXãƒ—ãƒ©ãƒ³ã§ClaudeCodeè‡ªå‹•ãƒ¬ãƒ“ãƒ¥ãƒ¼é–‹å§‹ãƒŠãƒªï¼"
        
        # å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’ClaudeCodeã§è§£æãƒŠãƒª
        for file in ${{ steps.changed-files.outputs.changed-files }}; do
          if [[ -f "$file" ]]; then
            echo "ğŸ” $file ã‚’è§£æä¸­ãƒŠãƒª..."
            
            # ClaudeCodeã§ãƒ•ã‚¡ã‚¤ãƒ«è§£æï¼†ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒŠãƒª
            claude-code review "$file" \
              --context "NSF to MML converter project" \
              --focus "code quality, performance, security, best practices" \
              --output-format "github-comment" \
              --save-to "review_${file//\//_}.md"
          fi
        done

    - name: ğŸ“ PRã«ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿ãƒŠãƒª
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        # ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœã‚’PRã«ã‚³ãƒ¡ãƒ³ãƒˆã¨ã—ã¦æŠ•ç¨¿ãƒŠãƒª
        echo "ğŸ“‹ ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœã‚’PRã«æŠ•ç¨¿ã™ã‚‹ãƒŠãƒªï¼"
        
        # ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚³ãƒ¡ãƒ³ãƒˆã‚’çµåˆãƒŠãƒª
        echo "## ğŸ¤– ClaudeCode è‡ªå‹•ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœãƒŠãƒªï¼" > final_review.md
        echo "" >> final_review.md
        echo "### ğŸ“Š è§£æå¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«" >> final_review.md
        echo "${{ steps.changed-files.outputs.changed-files }}" | tr ' ' '\n' | sed 's/^/- /' >> final_review.md
        echo "" >> final_review.md
        
        # å„ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœã‚’è¿½åŠ ãƒŠãƒª
        for review_file in review_*.md; do
          if [[ -f "$review_file" ]]; then
            echo "### ğŸ“„ $(echo $review_file | sed 's/review_//;s/_/\//g;s/\.md$//')" >> final_review.md
            cat "$review_file" >> final_review.md
            echo "" >> final_review.md
          fi
        done
        
        # GitHub APIã§PRã«ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿ãƒŠãƒª
        gh pr comment ${{ github.event.number }} \
          --body-file final_review.md \
          --repo ${{ github.repository }}

    - name: ğŸ” é™çš„è§£æå®Ÿè¡ŒãƒŠãƒª
      run: |
        echo "ğŸ”¬ è¿½åŠ ã®é™çš„è§£æã‚’å®Ÿè¡Œã™ã‚‹ãƒŠãƒªï¼"
        
        # ESLintå®Ÿè¡Œï¼ˆJavaScriptãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®å ´åˆï¼‰
        if [[ -f "package.json" ]]; then
          npm install
          npm run lint || echo "âš ï¸ Lint warnings found"
        fi
        
        # ClaudeCodeã§åŒ…æ‹¬çš„ãªé™çš„è§£æãƒŠãƒª
        claude-code analyze . \
          --type "static-analysis" \
          --include-patterns "*.js,*.ts,*.py,*.cpp,*.h" \
          --exclude-patterns "node_modules,dist,build" \
          --output "static_analysis_report.md"

    - name: ğŸ“Š è§£æãƒ¬ãƒãƒ¼ãƒˆä½œæˆãƒŠãƒª
      if: always()
      run: |
        echo "ğŸ“ˆ æœ€çµ‚ãƒ¬ãƒãƒ¼ãƒˆã‚’ä½œæˆã™ã‚‹ãƒŠãƒªï¼"
        
        # è§£æã‚µãƒãƒªãƒ¼ã‚’ä½œæˆãƒŠãƒª
        echo "## ğŸ¯ ClaudeCode è§£æã‚µãƒãƒªãƒ¼ãƒŠãƒªï¼" > analysis_summary.md
        echo "" >> analysis_summary.md
        echo "- **PRç•ªå·**: #${{ github.event.number }}" >> analysis_summary.md
        echo "- **è§£ææ—¥æ™‚**: $(date)" >> analysis_summary.md
        echo "- **å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«æ•°**: $(echo '${{ steps.changed-files.outputs.changed-files }}' | wc -w)" >> analysis_summary.md
        echo "" >> analysis_summary.md
        
        if [[ -f "static_analysis_report.md" ]]; then
          echo "### ğŸ”¬ é™çš„è§£æçµæœ" >> analysis_summary.md
          cat static_analysis_report.md >> analysis_summary.md
        fi
        
        # ãƒ¬ãƒãƒ¼ãƒˆã‚’Artifactã¨ã—ã¦ä¿å­˜ãƒŠãƒª
        echo "ğŸ’¾ ãƒ¬ãƒãƒ¼ãƒˆã‚’ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã¨ã—ã¦ä¿å­˜ãƒŠãƒªï¼"
        
    - name: ğŸ“¤ ãƒ¬ãƒãƒ¼ãƒˆã‚’ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã¨ã—ã¦ä¿å­˜ãƒŠãƒª
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: claudecode-review-report-${{ github.event.number }}
        path: |
          *.md
          review_*.md
        retention-days: 30

    - name: ğŸ‰ å®Œäº†é€šçŸ¥ãƒŠãƒª
      if: success()
      run: |
        echo "âœ… ClaudeCode è‡ªå‹•ãƒ¬ãƒ“ãƒ¥ãƒ¼å®Œäº†ãƒŠãƒªï¼"
        echo "ğŸ“‹ PR #${{ github.event.number }} ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒå®Œäº†ã—ãŸãƒŠãƒªï¼"
        
        # Slackã«é€šçŸ¥ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
        # curl -X POST -H 'Content-type: application/json' \
        #   --data '{"text":"ğŸ¤– ClaudeCode ãƒ¬ãƒ“ãƒ¥ãƒ¼å®Œäº†ãƒŠãƒªï¼ PR #${{ github.event.number }}"}' \
        #   ${{ secrets.SLACK_WEBHOOK_URL }}